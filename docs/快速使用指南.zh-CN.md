# 快速使用指南（Aegis / 中文）

本指南面向“能直接照抄跑起来”的最短路径；更完整说明见 `docs/USAGE.zh-CN.md`。

## 0) 你会用到的目录

- `framework/`：框架本体（C89，静态内存，DDD+CQRS，严格依赖注入）
- `framework/port/<platform>/`：平台移植层（HAL/critical/entry_platform）
- `application/`：示例应用（组合根 Entry）
- `examples/`：示例（推荐先看 `minimal_app`）
- `tools/`：强约束检查（命名/分层/ISR/追溯/禁 malloc/禁可变全局）

## 1) 构建与运行（x86_sim）

在仓库根目录：
```bash
cmake -S . -B build
cmake --build build -j4
ctest --test-dir build --output-on-failure
```

运行示例：
```bash
./examples/minimal_app/minimal_app
./examples/event_driven/event_driven
```

## 2) 约束检查（强制 DDD + CQRS + DI）

```bash
cmake --build build --target constraint_checks
```

这些检查是 Aegis 的“强约束”核心：不满足就应当失败（越早失败越省时间）。

## 3) 架构速记：分层 + 依赖注入

- Entry（组合根）负责“装配”：初始化平台依赖、注入仓储/时钟、拼装模块。
- Application 只做用例编排（命令/查询 handler），不做业务规则、不依赖 Infrastructure。
- Domain 承载业务规则（聚合/值对象/领域服务/领域事件），只依赖 Common。
- Infrastructure/Port 提供仓储实现与硬件适配（GPIO/Timer/Critical 等），可依赖 Domain 接口。

强制规则：Entry/Application 禁止直接 `#include "infrastructure_*.h"`；仓储实现只能在 `entry_platform`（平台侧）装配后注入。

## 4) 最小“应用启动”骨架（组合根）

典型顺序（参考 `examples/minimal_app/main.c`）：
1) `aegis_entry_platform_init(now_ms_fn, ctx)` 初始化平台侧依赖
2) `aegis_entry_platform_get_write_repo()` 拿到写仓储接口
3) 把 `write_repo` 注入 `aegis_entry_init_all(&runtime, &cfg)`
4) 注册模块（多个 BC/子域可按需拼装）
5) 主循环 `aegis_entry_main_loop_once()` 或 `aegis_entry_main_loop()`

## 5) 新增一个业务模块（推荐：脚手架 + 宏）

生成骨架：
```bash
python3 tools/scaffold_module.py --name charger --out examples/charger
```

模块注册函数签名固定（便于声明式拼装）：
```c
AegisErrorCode charger_application_register(AegisAppRuntime* app, void* ctx);
```

在 Entry 装配模块（严格依赖注入）：
```c
#include "app_module.h"
#include "app_macros.h"

AegisAppModule modules[1];
APP_MODULE_SET(&modules[0], charger_application_register, &charger_module);
APP_REGISTER_MODULES(ret, &runtime.app, modules);
```

在 handler 中读写 payload（编译期限制尺寸，减少 memcpy/size 判断）：
```c
#include "app_macros.h"
APP_CMD_PAYLOAD_GET(ret, cmd, &payload);
APP_QUERY_RESULT_PAYLOAD_SET(ret, resp, &dto);
```

## 6) CQRS：命令与查询怎么走

- 命令：ISR 里只做 `aegis_app_cmd_enqueue()`；主循环里由 Entry 触发出队与执行（用例编排在 Application）。
- 查询：同步执行（`aegis_app_query_execute()`），返回 `AegisQueryResponse`，建议把 DTO 写入 response payload。

## 7) 平台移植：STM32F030 示例

示例移植代码在 `framework/port/stm32f030/`：
- `port_critical.c`：PRIMASK 临界区
- `port_hal_gpio.c`：GPIO 寄存器级示例
- `port_hal_timer.c`：SysTick tick + 软件定时器示例
- `entry_platform.c`：平台侧装配（默认 inmem 仓储实现 + now_ms 注入）

选择平台构建（MCU 工程通常关闭 tests/examples）：
```bash
cmake -S . -B build/stm32f030 -DTARGET_PLATFORM=stm32f030 -DBUILD_TESTS=OFF -DBUILD_EXAMPLES=OFF
cmake --build build/stm32f030 -j4
```

提示：该目录是“移植示例”，不包含启动文件/链接脚本/时钟树初始化；你需要在 MCU 工程里配置 SysTick 1ms tick（或在 `SysTick_Handler` 中维护 tick）。

